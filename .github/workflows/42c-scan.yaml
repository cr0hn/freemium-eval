name: "42Crunch API Security Scan new"

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "main" ]

env:
#    TARGET_URL: "http://127.0.0.1:8080/api"
    TARGET_URL: "http://app:8090/api"
    USER_NAME: "misty94@demo.mail"
    USER_PASS: "ball"

jobs:
  run_42c_scan:
    runs-on: ubuntu-20.04
    permissions:
     contents: read # for actions/checkout to fetch code
     security-events: write # for results upload to Github Code Scanning
    container:
      image: docker:20.10.7
      options: --user root

    services:
        pixidb:
          image: 42crunch/pixi:mongo
          options: >-
            --quiet
            --health-cmd mongo
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
          ports:
            - 27017:27017
        app:
          image: 42crunch/pixi:v4.7
          options: --link pixidb
          ports:
            - 8090:8090

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Exit
        run: |
          cat /etc/hosts
          docker network ls
          ping -c 5 jobs.run_42c_scan.services.app
          ping -c 5 jobs.run_42c_scan.services.pixidb
          curl -v http://app:8090/api

      - name: curl
        run: | 
          docker run --rm alpine/curl -v http://app:8090/api
